---
layout: post
title:  "fcn.004016de @ 73677cb40830e94fbfb5483ff33e40b9"
date:   2021-08-30 15:52:19 +0300
categories: report
index: false
---

# Generic Information
- **Function:** fcn.004016de
- **Origin (md5):** 73677cb40830e94fbfb5483ff33e40b9
- **VirusTotal:** [virustotal.com/gui/file/73677cb40830e94fbfb5483ff33e40b9][virustotal_ref]

# Code Tags
<span class="tag" id="PROCESS">PROCESS</span>


# Similar Functions

1. [fcn.00409190][similar_1_ref] (sim.: 0.8922362065650576)
2. [fcn.00405242][similar_2_ref] (sim.: 0.8855542609591557)
3. [fcn.004031d7][similar_3_ref] (sim.: 0.8848658063499399)
4. [fcn.004031d7][similar_4_ref] (sim.: 0.8848658063499399)
5. [fcn.004031d7][similar_5_ref] (sim.: 0.8848658063499399)


# Disassembled Code

{% highlight nasm %}
push ebp
mov ebp,esp
sub esp,0x4c0
push esi
push edi
lea esi,[ebx+0x6a010]
push esi
call dword[sym.imp.KERNEL32.dll_EnterCriticalSection]
push 0x6a000
xor edi,edi
push edi
push ebx
call fcn.0040394e
add esp,0xc
push esi
mov dword[ebx+0x6a000],edi
call dword[sym.imp.KERNEL32.dll_LeaveCriticalSection]
push edi
push 2
call sub.KERNEL32.dll_CreateToolhelp32Snapshot
mov esi,eax
cmp esi,0xffffffff
mov dword[ebp-0x1c],esi
je 0x40194b
lea eax,[ebp-0x4c0]
push eax
push esi
mov dword[ebp-0x4c0],0x128
call sub.KERNEL32.dll_Process32First
test eax,eax
jne 0x40174b
push esi
jmp 0x401945
lea ecx,[ebp-0x398]
call fcn.004015a3
mov edx,dword[ebp-0x4b8]
test edx,edx
mov dword[ebp-0x398],edx
lea ecx,[ebp-0x49c]
jne 0x401771
mov ecx,str.System_Idle_Process
lea esi,[ebp-0x394]
mov al,byte[ecx]
inc ecx
mov byte[esi],al
inc esi
test al,al
jne 0x401777
test edx,edx
jne 0x401794
mov esi,str.SYSTEM
lea edi,[ebp-0x290]
movsd dword es:[edi],dword ptr[esi]
movsw word es:[edi],word ptr[esi]
movsb byte es:[edi],byte ptr[esi]
push edx
push 0
push 0x410
call dword[sym.imp.KERNEL32.dll_OpenProcess]
mov esi,eax
test esi,esi
je 0x401864
mov edi,0x104
push edi
lea eax,[ebp-0x170]
push eax
push esi
call sub.PSAPI.DLL_GetProcessImageFileNameA
lea eax,[ebp-0x170]
push eax
call fcn.00401d52
push edi
lea eax,[ebp-0x170]
push eax
push eax
call dword[sym.imp.KERNEL32.dll_GetLongPathNameA]
push esi
call dword[sym.imp.KERNEL32.dll_GetPriorityClass]
mov dword[ebp-0x184],eax
mov ecx,eax
lea eax,[ebp-0x398]
call fcn.00401604
lea eax,[ebp-0x290]
push eax
push esi
call fcn.00401b74
push 0x28
lea eax,[ebp-0x44]
push eax
push esi
call sub.PSAPI.DLL_GetProcessMemoryInfo
test eax,eax
je 0x40181d
mov eax,dword[ebp-0x38]
shr eax,0xa
mov dword[ebp-0x188],eax
lea eax,[ebp-8]
push eax
mov dword[ebp-0x50],esi
call dword[sym.imp.KERNEL32.dll_GetSystemTimeAsFileTime]
mov eax,dword[ebp-8]
mov dword[ebp-0x68],eax
mov eax,dword[ebp-4]
mov dword[ebp-0x64],eax
lea eax,[ebp-0x18]
push eax
lea eax,[ebp-0x10]
push eax
lea eax,[ebp-8]
push eax
push eax
push dword[ebp-0x50]
call dword[sym.imp.KERNEL32.dll_GetProcessTimes]
mov eax,dword[ebp-0x10]
mov dword[ebp-0x60],eax
mov eax,dword[ebp-0xc]
mov dword[ebp-0x5c],eax
mov eax,dword[ebp-0x18]
mov dword[ebp-0x58],eax
mov eax,dword[ebp-0x14]
mov dword[ebp-0x54],eax
lea eax,[ebx+0x6a010]
push eax
call dword[sym.imp.KERNEL32.dll_EnterCriticalSection]
mov edi,dword[ebx+0x6a000]
imul edi,edi,0x350
add edi,ebx
lea eax,[ebx+0x6a010]
mov ecx,0xd4
lea esi,[ebp-0x398]
rep movsd dword es:[edi],dword ptr[esi]
inc dword[ebx+0x6a000]
push eax
call dword[sym.imp.KERNEL32.dll_LeaveCriticalSection]
lea eax,[ebp-0x4c0]
push eax
push dword[ebp-0x1c]
call sub.KERNEL32.dll_Process32Next
test eax,eax
jne 0x40174b
push 0x5dc
call dword[sym.imp.KERNEL32.dll_Sleep]
lea eax,[ebx+0x6a010]
xor esi,esi
push eax
mov dword[ebp-0xc],0x64
mov dword[ebp-4],esi
call dword[sym.imp.KERNEL32.dll_EnterCriticalSection]
cmp dword[ebx+0x6a000],esi
mov dword[ebp-0x14],esi
jbe 0x401927
mov esi,ebx
lea edi,[esi+0x348]
cmp dword[edi],0
je 0x40190b
push ebx
call fcn.00401c75
mov ax,word[edi-0x13c]
push dword[edi]
sub word[ebp-0xc],ax
call dword[sym.imp.KERNEL32.dll_CloseHandle]
cmp dword[esi],0
jne 0x401913
mov dword[ebp-4],esi
inc dword[ebp-0x14]
mov eax,dword[ebp-0x14]
add esi,0x350
cmp eax,dword[ebx+0x6a000]
jb 0x4018e7
mov ax,word[ebp-0xc]
mov ecx,dword[ebp-4]
mov word[ecx+0x20c],ax
lea eax,[ebx+0x6a010]
push eax
call dword[sym.imp.KERNEL32.dll_LeaveCriticalSection]
push dword[ebp-0x1c]
call dword[sym.imp.KERNEL32.dll_CloseHandle]
mov eax,dword[ebx+0x6a000]
pop edi
pop esi
leave
ret
{% endhighlight %}


[similar_1_ref]: /report/fcn.00409190@470263fe7e7cc115b95cd041d643e3b5
[similar_2_ref]: /report/fcn.00405242@73677cb40830e94fbfb5483ff33e40b9
[similar_3_ref]: /report/fcn.004031d7@3a783d6a0e3505903843983e413a529e
[similar_4_ref]: /report/fcn.004031d7@d287262b3c4caae6c69c406382125319
[similar_5_ref]: /report/fcn.004031d7@57989f43bf24a9272122210a17558c3d
[virustotal_ref]: https://www.virustotal.com/gui/file/73677cb40830e94fbfb5483ff33e40b9