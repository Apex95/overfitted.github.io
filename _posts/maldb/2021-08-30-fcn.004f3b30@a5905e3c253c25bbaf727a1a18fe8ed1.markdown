---
layout: post
title:  "fcn.004f3b30 @ a5905e3c253c25bbaf727a1a18fe8ed1"
date:   2021-08-30 15:52:19 +0300
categories: report
index: false
---

# Generic Information
- **Function:** fcn.004f3b30
- **Origin (md5):** a5905e3c253c25bbaf727a1a18fe8ed1
- **VirusTotal:** [virustotal.com/gui/file/a5905e3c253c25bbaf727a1a18fe8ed1][virustotal_ref]

# Code Tags
<span class="tag" id="THREAD">THREAD</span>


# Similar Functions

1. [fcn.00428780][similar_1_ref] (sim.: 1.0)
2. [fcn.0067de20][similar_2_ref] (sim.: 0.9702252061546262)
3. [fcn.005c8390][similar_3_ref] (sim.: 0.9686975655705423)
4. [fcn.0061d9d0][similar_4_ref] (sim.: 0.9660250785598588)
5. [fcn.0060ab90][similar_5_ref] (sim.: 0.9631168266999496)


# Disassembled Code

{% highlight nasm %}
push r15
push r14
push r13
push r12
push rbp
push rdi
push rsi
push rbx
sub rsp,0x88
lea rax,fcn.007169b0
mov rsi,qword[0x00a7d870]
mov rdi,rcx
mov qword[rcx],rax
lea rax,[0x00b6c280]
cmp rsi,0xffffffffffffffc0
mov qword[rcx+0x58],rax
lea rax,[0x00b6c298]
mov qword[rcx+0x60],rax
lea rax,[0x00b6c2b0]
mov qword[rcx+0x70],rax
lea rax,[0x00b6c2c8]
mov qword[rcx+0xb8],rax
lea rax,[0x00b6c2e0]
mov qword[rcx+0x100],rax
lea rax,[rcx+0x100]
mov qword[rsp+0x38],rax
je 0x4f3e6e
lea r12,[rsi+0x44]
call qword[sym.imp.KERNEL32.dll_GetCurrentThreadId]
mov r13d,eax
xor eax,eax
lock cmpxchg dword[r12],eax
cmp r13d,eax
je 0x4f3c80
lea rbp,[rsi+0x48]
mov ebx,dword[rsi+0x48]
jmp 0x4f3bd3
mov ebx,eax
mov edx,ebx
mov r8d,ebx
mov rcx,rbp
or edx,0x80000000
call fcn.008eebc0
cmp ebx,eax
jne 0x4f3bd1
test ebx,ebx
js 0x4f3d10
xchg dword[r12],r13d
mov dword[rsi+0x40],1
mov rdx,qword[rsi+0x18]
mov rcx,qword[rsi+0x10]
lea r8,[rsp+0x38]
xor r9d,r9d
call fcn.00a54c40
mov r9,qword[rsi+0x18]
cmp r9,rax
je 0x4f3c3e
lea rdx,[rax+8]
cmp r9,rdx
je 0x4f3c36
mov r8,r9
sub r8,rdx
mov rcx,r8
sar rcx,3
test rcx,rcx
jne 0x4f3c90
sub r9,8
mov qword[rsi+0x18],r9
mov eax,dword[rsi+0x40]
sub eax,1
test eax,eax
mov dword[rsi+0x40],eax
je 0x4f3ca0
mov rcx,qword[rdi+0x108]
test rcx,rcx
je 0x4f3c5c
call fcn.00a5af30
mov rcx,rdi
call fcn.004ecfd0
nop
add rsp,0x88
pop rbx
pop rsi
pop rdi
pop rbp
pop r12
pop r13
pop r14
pop r15
ret
add dword[rsi+0x40],1
jmp 0x4f3bfd
mov rcx,rax
call sub.msvcrt.dll_memmove
mov r9,qword[rsi+0x18]
jmp 0x4f3c36
xchg dword[r12],eax
mov eax,0x80000000
lea rbp,[rsi+0x48]
lock xadd dword[rbp],eax
test eax,0x40000000
jne 0x4f3c4b
cmp eax,0x80000000
je 0x4f3c4b
mov ebx,dword[rsi+0x48]
jmp 0x4f3cc7
mov ebx,eax
mov edx,ebx
mov r8d,ebx
mov rcx,rbp
or edx,0x40000000
call fcn.008eebc0
cmp ebx,eax
jne 0x4f3cc5
and ebx,0x40000000
jne 0x4f3c4b
add rsi,0x50
xor eax,eax
lock cmpxchg qword[rsi],rax
test rax,rax
mov rbx,rax
je 0x4f3de5
mov rcx,rbx
call qword[sym.imp.KERNEL32.dll_SetEvent]
jmp 0x4f3c4b
mov edx,dword[rsi+0x48]
jmp 0x4f3d17
mov edx,eax
lea eax,[rdx+1]
mov r10d,edx
or r10d,0x80000000
test edx,edx
cmovns eax,r10d
mov ebx,eax
mov eax,edx
lock cmpxchg dword[rbp],ebx
cmp eax,edx
jne 0x4f3d15
mov eax,ebx
shr eax,0x1f
test al,al
je 0x4f3bf2
shr edx,0x1f
test dl,dl
je 0x4f3bf2
lea r15,[rsi+0x50]
xor eax,eax
lock cmpxchg qword[r15],rax
test rax,rax
mov r14,rax
mov qword[rsp+0x28],rax
je 0x4f3e1c
mov r15,qword[sym.imp.KERNEL32.dll_WaitForSingleObjectEx]
mov r14d,0xffffffff
nop dword[rax+rax]
and ebx,0x7fffffff
xor r8d,r8d
mov edx,r14d
mov rcx,qword[rsp+0x28]
call r15
mov r10d,ebx
or r10d,0x40000000
jmp 0x4f3dc6
lea ecx,[r10-1]
mov eax,r10d
and ecx,0x3fffffff
or ecx,0x80000000
lock cmpxchg dword[rbp],ecx
cmp eax,r10d
mov ebx,eax
je 0x4f3bf2
mov r10d,ebx
test r10d,r10d
jns 0x4f3da0
mov ecx,r10d
mov eax,r10d
and ecx,0xbfffffff
lock cmpxchg dword[rbp],ecx
cmp eax,r10d
mov ebx,eax
jne 0x4f3dc3
jmp 0x4f3d80
xor ecx,ecx
xor r9d,r9d
xor r8d,r8d
xor edx,edx
call qword[sym.imp.KERNEL32.dll_CreateEventA]
test rax,rax
mov rcx,rax
je 0x4f3edb
mov rax,rbx
lock cmpxchg qword[rsi],rcx
test rax,rax
mov rbx,rax
je 0x4f3e66
call qword[sym.imp.KERNEL32.dll_CloseHandle]
jmp 0x4f3d01
xor r9d,r9d
xor r8d,r8d
xor edx,edx
xor ecx,ecx
call qword[sym.imp.KERNEL32.dll_CreateEventA]
test rax,rax
mov qword[rsp+0x28],rax
je 0x4f3f2f
mov rcx,rax
mov rax,r14
lock cmpxchg qword[r15],rcx
test rax,rax
mov r14,rax
je 0x4f3d6b
mov rcx,qword[rsp+0x28]
call qword[sym.imp.KERNEL32.dll_CloseHandle]
mov qword[rsp+0x28],r14
jmp 0x4f3d6b
mov rbx,rcx
jmp 0x4f3d01
lea rbx,[rsp+0x40]
call fcn.006ea660
lea rdx,[0x00a96b68]
mov rcx,rbx
mov rsi,rax
call fcn.009de540
lea rax,[rbx+0x30]
mov rcx,rbx
mov dword[rsp+0x50],1
mov qword[rsp+0x58],rsi
mov qword[rsp+0x68],0
mov qword[rsp+0x60],rax
lea rax,[0x00b714e0]
mov byte[rsp+0x70],0
mov qword[rsp+0x40],rax
call fcn.009472d0
lea rax,[0x00b72450]
mov rcx,rbx
mov qword[rsp+0x40],rax
call fcn.00962490
call fcn.00a55e20
lea rbx,[rsp+0x40]
call fcn.006ea660
lea rdx,[0x00a96b4a]
mov rcx,rbx
mov rsi,rax
call fcn.009de540
lea rax,[rbx+0x30]
mov rcx,rbx
mov dword[rsp+0x50],0xb
mov qword[rsp+0x58],rsi
mov qword[rsp+0x68],0
mov qword[rsp+0x60],rax
lea rax,[0x00b72480]
mov byte[rsp+0x70],0
mov qword[rsp+0x40],rax
call fcn.00947760
lea rbx,[rsp+0x40]
call fcn.006ea660
lea rdx,[0x00a96b4a]
mov rcx,rbx
mov rsi,rax
call fcn.009de540
lea rax,[rbx+0x30]
mov rcx,rbx
mov dword[rsp+0x50],0xb
mov qword[rsp+0x58],rsi
mov qword[rsp+0x68],0
mov qword[rsp+0x60],rax
lea rax,[0x00b72480]
mov byte[rsp+0x70],0
mov qword[rsp+0x40],rax
call fcn.00947760
jmp 0x4f3ec2
{% endhighlight %}


[similar_1_ref]: /report/fcn.00428780@a5905e3c253c25bbaf727a1a18fe8ed1
[similar_2_ref]: /report/fcn.0067de20@a5905e3c253c25bbaf727a1a18fe8ed1
[similar_3_ref]: /report/fcn.005c8390@a5905e3c253c25bbaf727a1a18fe8ed1
[similar_4_ref]: /report/fcn.0061d9d0@a5905e3c253c25bbaf727a1a18fe8ed1
[similar_5_ref]: /report/fcn.0060ab90@a5905e3c253c25bbaf727a1a18fe8ed1
[virustotal_ref]: https://www.virustotal.com/gui/file/a5905e3c253c25bbaf727a1a18fe8ed1