---
layout: post
title:  "fcn.004581f7 @ d96761eb00d2d97e2b6f5ffffed0b46a"
date:   2021-08-30 15:52:19 +0300
categories: report
index: false
---

# Generic Information
- **Function:** fcn.004581f7
- **Origin (md5):** d96761eb00d2d97e2b6f5ffffed0b46a
- **VirusTotal:** [virustotal.com/gui/file/d96761eb00d2d97e2b6f5ffffed0b46a][virustotal_ref]

# Code Tags
<span class="tag" id="MEMORY">MEMORY</span>


# Similar Functions

1. [fcn.004583f4][similar_1_ref] (sim.: 0.9979409850762746)
2. [fcn.0042eb45][similar_2_ref] (sim.: 0.8947270722052489)
3. [fcn.0042d4bf][similar_3_ref] (sim.: 0.8899474765788032)
4. [fcn.0042d4bf][similar_4_ref] (sim.: 0.8899474765788032)
5. [fcn.0042d4bf][similar_5_ref] (sim.: 0.8899474765788032)


# Disassembled Code

{% highlight nasm %}
push ebp
mov ebp,esp
sub esp,0x30
push ebx
push esi
push edi
lea eax,[ebp-0x18]
mov dword[ebp-0x14],4
push eax
xor ebx,ebx
lea eax,[ebp-0x10]
push ecx
mov ecx,dword[ebp+8]
lea edx,[ebp-0x14]
mov esi,ebx
mov dword[ebp-0x10],ebx
push eax
mov dword[ebp-8],ebx
mov edi,ebx
mov dword[ebp-0xc],esi
call fcn.0045874a
add esp,0xc
test al,al
je 0x4583cb
push dword[ebp-0x18]
lea ecx,[ebp-8]
call fcn.004587e7
pop ecx
test al,al
je 0x4583cb
lea eax,[ebp-0x24]
mov dword[ebp-4],ebx
push eax
lea eax,[ebp-4]
push eax
lea eax,[ebp-0x1c]
push eax
push dword[ebp-0x10]
call dword[sym.imp.ADVAPI32.dll_GetSecurityDescriptorDacl]
test eax,eax
je 0x4583cb
push 0xc
lea eax,[ebp-0x30]
push ebx
push eax
call fcn.00423020
add esp,0xc
mov dword[ebp-0x2c],8
cmp dword[ebp-4],ebx
je 0x45829d
push 2
push 0xc
lea eax,[ebp-0x30]
push eax
push dword[ebp-4]
call dword[sym.imp.ADVAPI32.dll_GetAclInformation]
test eax,eax
je 0x4583cb
push dword[ebp+0xc]
call dword[sym.imp.ADVAPI32.dll_GetLengthSid]
mov ecx,dword[ebp-0x2c]
push ecx
lea edx,[ecx+0x10]
lea edx,[edx+eax*2]
lea ecx,[ebp-0xc]
call fcn.004587b3
mov esi,dword[ebp-0xc]
pop ecx
test al,al
je 0x4583cb
cmp dword[ebp-0x1c],ebx
je 0x458313
mov ecx,dword[ebp-0x30]
test ecx,ecx
je 0x458313
mov eax,ebx
mov dword[ebp-0xc],eax
lea ecx,[ebp-0x20]
push ecx
push eax
push dword[ebp-4]
call dword[sym.imp.ADVAPI32.dll_GetAce]
test eax,eax
je 0x4583cb
mov ecx,dword[ebp-0x20]
movzx eax,word[ecx+2]
push eax
push ecx
push 0xffffffffffffffff
push 2
push esi
call dword[sym.imp.ADVAPI32.dll_AddAce]
test eax,eax
je 0x4583cb
mov eax,dword[ebp-0xc]
inc eax
mov dword[ebp-0xc],eax
cmp eax,dword[ebp-0x30]
jb 0x4582d5
push dword[ebp+0xc]
call dword[sym.imp.ADVAPI32.dll_GetLengthSid]
add eax,8
push eax
push 8
mov dword[ebp-0x20],eax
call dword[sym.imp.KERNEL32.dll_GetProcessHeap]
push eax
call dword[sym.imp.KERNEL32.dll_HeapAlloc]
mov edi,eax
test edi,edi
je 0x4583cb
mov eax,dword[ebp-0x20]
push dword[ebp+0xc]
mov word[edi+2],ax
lea eax,[edi+8]
push eax
push dword[ebp+0xc]
call dword[sym.imp.ADVAPI32.dll_GetLengthSid]
push eax
call dword[sym.imp.ADVAPI32.dll_CopySid]
test eax,eax
je 0x4583cb
mov ecx,dword[ebp+0x10]
add ecx,4
mov dword[ebp+0xc],ebx
mov dword[ebp+0x10],ecx
mov al,byte[ecx-4]
mov byte[edi],al
mov al,byte[ecx-3]
mov byte[edi+1],al
mov eax,dword[ecx]
mov dword[edi+4],eax
movzx eax,word[edi+2]
push eax
push edi
push 0xffffffffffffffff
push 2
push esi
call dword[sym.imp.ADVAPI32.dll_AddAce]
test eax,eax
je 0x4583cb
mov eax,dword[ebp+0xc]
mov ecx,dword[ebp+0x10]
inc eax
add ecx,0xc
mov dword[ebp+0xc],eax
mov dword[ebp+0x10],ecx
cmp eax,1
jb 0x45836a
push ebx
push esi
push 1
push dword[ebp-8]
call dword[sym.imp.ADVAPI32.dll_SetSecurityDescriptorDacl]
test eax,eax
je 0x4583cb
push dword[ebp-8]
lea eax,[ebp-0x14]
push eax
push dword[ebp+8]
call dword[sym.imp.USER32.dll_SetUserObjectSecurity]
test eax,eax
je 0x4583cb
mov bl,1
mov ecx,dword[ebp-0x10]
call fcn.004586b3
mov ecx,dword[ebp-8]
call fcn.004586b3
mov ecx,esi
call fcn.004586b3
mov ecx,edi
call fcn.004586b3
pop edi
pop esi
mov al,bl
pop ebx
mov esp,ebp
pop ebp
ret 0x10
{% endhighlight %}


[similar_1_ref]: /report/fcn.004583f4@d96761eb00d2d97e2b6f5ffffed0b46a
[similar_2_ref]: /report/fcn.0042eb45@20a93604f17ee6f3c2aa7b1f7a497fcf
[similar_3_ref]: /report/fcn.0042d4bf@96a869ae624ddb4834a1d5a829f85469
[similar_4_ref]: /report/fcn.0042d4bf@505be53c36227b94e2fcc406f247f6e5
[similar_5_ref]: /report/fcn.0042d4bf@c077742bdc6d4f2c0ca7d0e2a6a94acf
[virustotal_ref]: https://www.virustotal.com/gui/file/d96761eb00d2d97e2b6f5ffffed0b46a