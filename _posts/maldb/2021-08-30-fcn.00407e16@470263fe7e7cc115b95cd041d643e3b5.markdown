---
layout: post
title:  "fcn.00407e16 @ 470263fe7e7cc115b95cd041d643e3b5"
date:   2021-08-30 15:52:19 +0300
categories: report
index: false
---

# Generic Information
- **Function:** fcn.00407e16
- **Origin (md5):** 470263fe7e7cc115b95cd041d643e3b5
- **VirusTotal:** [virustotal.com/gui/file/470263fe7e7cc115b95cd041d643e3b5][virustotal_ref]

# Code Tags
<span class="tag" id="MEMORY">MEMORY</span>
<span class="tag" id="LINKING">LINKING</span>


# Similar Functions

1. [fcn.00406fd0][similar_1_ref] (sim.: 0.8749881290678752)
2. [fcn.0040303e][similar_2_ref] (sim.: 0.869018543733284)
3. [fcn.0040d292][similar_3_ref] (sim.: 0.8650450716972553)
4. [fcn.00435800][similar_4_ref] (sim.: 0.8613910343277846)
5. [fcn.0040bf31][similar_5_ref] (sim.: 0.8611625929591693)


# Disassembled Code

{% highlight nasm %}
push ebp
mov ebp,esp
and esp,0xfffffff8
sub esp,0x84
push ebx
push esi
mov esi,dword[sym.imp.KERNEL32.dll_VirtualAlloc]
mov ebx,ecx
push edi
xor edi,edi
mov dword[esp+0x20],ebx
cmp dword[ebx],edi
je 0x407e5d
push 4
push 0x3000
push 0x202
push edi
call esi
lea ecx,[esp+0x1c]
mov dword[ebx+8],eax
push ecx
push eax
mov dword[esp+0x24],0x100
call dword[sym.imp.ADVAPI32.dll_GetUserNameW]
cmp dword[ebx+0xc],edi
je 0x407e85
push 4
push 0x3000
push 0x20
push edi
mov dword[esp+0x2c],0x1e
call esi
lea ecx,[esp+0x1c]
mov dword[ebx+0x14],eax
push ecx
push eax
call dword[sym.imp.KERNEL32.dll_GetComputerNameW]
cmp dword[ebx+0x18],edi
mov edi,dword[sym.imp.USER32.dll_wsprintfW]
je 0x407ee5
push 4
push 0x3000
push 0x80
xor eax,eax
push eax
call esi
mov dword[ebx+0x20],eax
test eax,eax
je 0x407ee5
push ecx
push 0x80
push eax
push str.Domain
push str.SYSTEMCurrentControlSetservicesTcpipParameters
push 0x80000002
call fcn.00407dba
test eax,eax
je 0x407ed9
mov eax,dword[ebx+0x20]
xor ecx,ecx
cmp word[eax],cx
jne 0x407ee5
push str.WORKGROUP
push eax
jmp 0x407ee1
push str.undefined
push dword[ebx+0x20]
call edi
pop ecx
pop ecx
xor eax,eax
cmp dword[ebx+0x30],eax
je 0x407f2e
push 4
push 0x3000
push 0x80
push eax
call esi
push ecx
push 0x40
push eax
push str.LocaleName
push str.Control_PanelInternational
push 0x80000001
mov dword[ebx+0x38],eax
call fcn.00407dba
test eax,eax
jne 0x407f2c
push 0x8000
push eax
push dword[ebx+0x38]
mov dword[ebx+0x30],eax
call dword[sym.imp.KERNEL32.dll_VirtualFree]
xor eax,eax
cmp dword[ebx+0x3c],eax
je 0x40801f
push 4
push 0x3000
push 0x8a
push eax
call esi
push 4
mov dword[esp+0x20],eax
add eax,0xe
push 0x3000
mov dword[esp+0x2c],eax
xor eax,eax
push 4
push eax
call esi
mov esi,dword[esp+0x24]
xor ecx,ecx
inc ecx
mov dword[ebx+0x44],eax
xor eax,eax
mov dword[esp+0x10],ecx
mov dword[esp+0x14],eax
mov eax,ecx
mov dword[esp+0x18],eax
push eax
push 0x4195a8
push dword[esp+0x24]
call edi
inc dword[esp+0x24]
add esp,8
push 0x80
push esi
push dword[esp+0x28]
push str.Keyboard_LayoutPreload
push 0x80000001
call fcn.00407dba
test eax,eax
je 0x407fd6
push str.00000419
push esi
call dword[sym.imp.KERNEL32.dll_lstrcmpiW]
test eax,eax
jne 0x407fe0
push 0x41a39c
push dword[ebx+0x44]
call edi
xor edx,edx
pop ecx
inc edx
xor eax,eax
pop ecx
mov ecx,eax
mov dword[esp+0x14],edx
mov dword[esp+0x10],ecx
jmp 0x407fe8
xor eax,eax
mov ecx,eax
mov dword[esp+0x10],ecx
jmp 0x407fe4
mov ecx,dword[esp+0x10]
mov edx,dword[esp+0x14]
mov eax,dword[esp+0x18]
cmp eax,9
je 0x407ff5
test ecx,ecx
jne 0x407f79
mov esi,dword[sym.imp.KERNEL32.dll_VirtualAlloc]
test edx,edx
jne 0x40800b
push 0x41a3a0
push dword[ebx+0x44]
call edi
pop ecx
pop ecx
push 0x8000
xor eax,eax
push eax
push dword[esp+0x24]
call dword[sym.imp.KERNEL32.dll_VirtualFree]
xor eax,eax
cmp dword[ebx+0x48],eax
je 0x408080
push 4
push 0x3000
push 0x82
push eax
call esi
push ecx
push 0x80
push eax
push 0x41a3a4
push str.SOFTWAREMicrosoftWindows_NTCurrentVersion
push 0x80000002
mov dword[ebx+0x50],eax
call fcn.00407dba
test eax,eax
jne 0x40807e
push ecx
push 0x80
push dword[ebx+0x50]
push 0x41a3a4
push str.SOFTWAREWow6432NodeMicrosoftWindows_NTCurrentVersion
push 0x80000002
call fcn.00407dba
push str.error
push dword[ebx+0x50]
call edi
pop ecx
pop ecx
xor eax,eax
cmp dword[ebx+0x54],eax
je 0x4080e1
lea eax,[esp+0x34]
push eax
call dword[sym.imp.KERNEL32.dll_GetNativeSystemInfo]
push 4
push 0x3000
push 0x40
xor eax,eax
push eax
call esi
movzx ecx,word[esp+0x34]
xor edx,edx
mov dword[ebx+0x5c],eax
sub ecx,edx
je 0x4080d5
sub ecx,5
je 0x4080ce
dec ecx
je 0x4080c7
sub ecx,3
je 0x4080c0
push str.Unknown
jmp 0x4080da
push 0x41a4a0
jmp 0x4080da
push str.Itanium
jmp 0x4080da
push 0x41a4a8
jmp 0x4080da
push 0x41a4c0
push eax
call edi
pop ecx
pop ecx
xor eax,eax
cmp dword[ebx+0x24],eax
je 0x408103
mov dword[esp+0x24],eax
lea eax,[esp+0x24]
push eax
lea eax,[ebx+0x2c]
push eax
call fcn.00408461
test eax,eax
jne 0x408101
mov dword[ebx+0x24],eax
jmp 0x408103
xor eax,eax
cmp dword[ebx+0x60],eax
je 0x40825a
push 4
push 0x3000
push 0x400
xor eax,eax
push eax
call esi
push 4
push 0x3000
mov dword[ebx+0x68],eax
xor eax,eax
push 0xe0c
push eax
call esi
push 0x100
push eax
mov dword[esp+0x20],eax
lea ecx,[eax+0x60c]
mov dword[esp+0x18],ecx
call dword[sym.imp.KERNEL32.dll_GetWindowsDirectoryW]
mov ecx,dword[esp+0x18]
xor eax,eax
push 0x100
mov word[ecx+6],ax
lea edx,[ecx+0x600]
lea eax,[ecx+0x400]
mov dword[esp+0x20],edx
push eax
lea eax,[ecx+0x604]
push eax
lea eax,[ecx+0x608]
push eax
push edx
push 0x100
lea eax,[ecx+0x200]
push eax
push ecx
call dword[sym.imp.KERNEL32.dll_GetVolumeInformationW]
push ecx
mov ecx,dword[esp+0x14]
push 0x80
push ecx
push str.ProcessorNameString
push str.HARDWAREDESCRIPTIONSystemCentralProcessor0
push 0x80000002
call fcn.00407dba
test eax,eax
je 0x4081dc
push dword[esp+0x10]
call dword[sym.imp.KERNEL32.dll_lstrlenW]
mov ecx,dword[esp+0x10]
push ecx
push 0x80
lea eax,[ecx+eax*2]
push eax
push str.Identifier
push str.HARDWAREDESCRIPTIONSystemCentralProcessor0
push 0x80000002
call fcn.00407dba
mov eax,dword[esp+0x1c]
push dword[eax]
push 0x4195a8
push dword[ebx+0x68]
call edi
mov edi,dword[sym.imp.KERNEL32.dll_lstrcatW]
add esp,0xc
push dword[esp+0x10]
push dword[ebx+0x68]
call edi
push str.RtlComputeCrc32
push str.ntdll.dll
call dword[sym.imp.KERNEL32.dll_GetModuleHandleW]
push eax
call dword[sym.imp.KERNEL32.dll_GetProcAddress]
mov dword[esp+0x24],eax
test eax,eax
je 0x408237
push dword[ebx+0x68]
call dword[sym.imp.KERNEL32.dll_lstrlenW]
add eax,eax
push eax
push dword[ebx+0x68]
push 0x29a
call dword[esp+0x30]
jmp 0x408239
xor eax,eax
mov dword[ebx+0x6c],eax
mov eax,dword[esp+0x1c]
push 0x8000
mov eax,dword[eax]
mov dword[ebx+0x70],eax
xor eax,eax
push eax
mov eax,dword[esp+0x20]
push eax
call dword[sym.imp.KERNEL32.dll_VirtualFree]
jmp 0x408260
mov edi,dword[sym.imp.KERNEL32.dll_lstrcatW]
xor eax,eax
cmp dword[ebx+0x74],eax
je 0x408421
push 4
push 0x3000
push 0x400
push eax
mov dword[esp+0x44],0x41a59c
mov dword[esp+0x48],0x41a5ac
mov dword[esp+0x4c],0x41a5c4
mov dword[esp+0x50],0x41a5d8
mov dword[esp+0x54],0x41a5e4
mov dword[esp+0x58],0x41a5f4
mov dword[esp+0x5c],0x41a600
call esi
push 0x41
mov dword[ebx+0x7c],eax
lea ecx,[esp+0x5c]
pop eax
mov word[ecx],ax
inc eax
lea ecx,[ecx+2]
cmp ax,0x5a
jbe 0x4082bc
mov eax,dword[0x41a610]
mov dword[esp+0x2c],eax
mov eax,dword[0x41a614]
mov dword[esp+0x30],eax
xor eax,eax
mov dword[esp+0x1c],eax
mov ax,word[esp+eax*2+0x58]
mov word[esp+0x2c],ax
lea eax,[esp+0x2c]
push eax
call dword[sym.imp.KERNEL32.dll_GetDriveTypeW]
mov esi,eax
cmp esi,2
jbe 0x4083f6
cmp esi,5
je 0x4083f6
xor eax,eax
mov word[esp+0x30],ax
lea eax,[esp+0x2c]
push eax
push dword[ebx+0x7c]
call edi
push 0x5c
pop eax
push dword[esp+esi*4+0x34]
mov word[esp+0x34],ax
push dword[ebx+0x7c]
call edi
push 0x41a618
push dword[ebx+0x7c]
call edi
lea eax,[esp+0x14]
push eax
lea eax,[esp+0x14]
push eax
lea eax,[esp+0x20]
push eax
lea eax,[esp+0x30]
push eax
lea eax,[esp+0x3c]
push eax
call dword[sym.imp.KERNEL32.dll_GetDiskFreeSpaceW]
test eax,eax
je 0x4083ec
mov esi,dword[esp+0x24]
xor eax,eax
imul esi,dword[esp+0x18]
push eax
push esi
push eax
push dword[esp+0x20]
call fcn.00410770
mov ebx,eax
mov edi,edx
xor eax,eax
push eax
push esi
push eax
push dword[esp+0x1c]
call fcn.00410770
mov ecx,ebx
mov esi,edi
sub ecx,eax
mov eax,dword[esp+0x20]
mov dword[esp+0x28],ecx
sbb esi,edx
push dword[eax+0x7c]
call dword[sym.imp.KERNEL32.dll_lstrlenW]
mov edx,dword[esp+0x20]
push edi
mov edi,dword[sym.imp.USER32.dll_wsprintfW]
push ebx
mov ecx,dword[edx+0x7c]
push 0x41a61c
lea eax,[ecx+eax*2]
push eax
call edi
mov ebx,dword[esp+0x30]
add esp,0x10
push dword[ebx+0x7c]
call dword[sym.imp.KERNEL32.dll_lstrlenW]
mov ecx,dword[ebx+0x7c]
push esi
push dword[esp+0x2c]
lea eax,[ecx+eax*2]
push str._I64u
push eax
call edi
mov edi,dword[sym.imp.KERNEL32.dll_lstrcatW]
add esp,0x10
push 0x41a638
jmp 0x4083f1
push 0x41a63c
push dword[ebx+0x7c]
call edi
mov eax,dword[esp+0x1c]
inc eax
mov dword[esp+0x1c],eax
cmp eax,0x1b
jb 0x4082e1
push dword[ebx+0x7c]
call dword[sym.imp.KERNEL32.dll_lstrlenW]
mov ecx,dword[ebx+0x7c]
xor edx,edx
mov esi,dword[sym.imp.KERNEL32.dll_VirtualAlloc]
mov word[ecx+eax*2-2],dx
xor edi,edi
cmp dword[ebx+0x80],edi
je 0x408457
push 4
push 0x3000
push 0x81
push edi
call esi
mov dword[ebx+0x84],eax
test eax,eax
je 0x408451
push 0x8000
push edi
push eax
call dword[sym.imp.KERNEL32.dll_VirtualFree]
mov dword[ebx+0x80],edi
pop edi
xor eax,eax
pop esi
inc eax
pop ebx
mov esp,ebp
pop ebp
ret
{% endhighlight %}


[similar_1_ref]: /report/fcn.00406fd0@0aa2d73a5300dff2412388945614b507
[similar_2_ref]: /report/fcn.0040303e@470263fe7e7cc115b95cd041d643e3b5
[similar_3_ref]: /report/fcn.0040d292@f5b8476c36459986b226c45654aeb016
[similar_4_ref]: /report/fcn.00435800@44e1ffcf4e71f4505c09d520fd75f1e4
[similar_5_ref]: /report/fcn.0040bf31@e16f74a2849182d98050864255e902f8
[virustotal_ref]: https://www.virustotal.com/gui/file/470263fe7e7cc115b95cd041d643e3b5