---
layout: post
title:  "method.QQDectector2꞉꞉CWinHttpFile.virtual_4 @ 0aa2d73a5300dff2412388945614b507"
date:   2021-08-30 15:52:19 +0300
categories: report
index: false
---

# Generic Information
- **Function:** method.QQDectector2꞉꞉CWinHttpFile.virtual\_4
- **Origin (md5):** 0aa2d73a5300dff2412388945614b507
- **VirusTotal:** [virustotal.com/gui/file/0aa2d73a5300dff2412388945614b507][virustotal_ref]

# Code Tags
<span class="tag" id="LINKING">LINKING</span>


# Similar Functions

1. [fcn.100066c0][similar_1_ref] (sim.: 0.9116322078014798)
2. [fcn.0044f064][similar_2_ref] (sim.: 0.9111011890526328)
3. [fcn.0041f004][similar_3_ref] (sim.: 0.9106416406443509)
4. [fcn.004371a0][similar_4_ref] (sim.: 0.8977003389283201)
5. [fcn.004034a9][similar_5_ref] (sim.: 0.8969840418118628)


# Disassembled Code

{% highlight nasm %}
push ebp
mov ebp,esp
and esp,0xfffffff8
push 0xffffffffffffffff
push 0x4388d6
mov eax,dword fs:[0]
push eax
push ecx
mov eax,0x18ac
call fcn.00433120
mov eax,dword[0x444120]
xor eax,esp
mov dword[esp+0x18a8],eax
push ebx
push esi
push edi
mov eax,dword[0x444120]
xor eax,esp
push eax
lea eax,[esp+0x18c0]
mov dword fs:[0],eax
mov eax,dword[ebp+0xc]
mov ebx,dword[ebp+8]
xor edi,edi
mov esi,ecx
push 0x3fe
lea ecx,[esp+0xba]
push edi
push ecx
mov dword[esp+0x24],esi
mov dword[esp+0x28],eax
mov dword[esp+0x30],edi
mov dword[esp+0x2c],edi
mov dword[esp+0x20],edi
mov dword[esp+0x3c],edi
mov dword[esp+0x50],edi
mov dword[esp+0x54],edi
mov dword[esp+0x34],edi
mov dword[esp+0x40],edi
mov dword[esp+0x44],edi
mov word[esp+0xc0],di
call fcn.0041dba0
push 0x1400
lea edx,[esp+0x4c4]
push edi
push edx
call fcn.0041dba0
push 0x38
lea eax,[esp+0x70]
push edi
push eax
call fcn.0041dba0
lea eax,[esp+0xcd8]
mov dword[esp+0x98],eax
lea edx,[esp+0x4d8]
mov dword[esp+0x84],edx
lea ecx,[esp+0x14d8]
lea eax,[esp+0x8d8]
mov dword[esp+0xa8],ecx
lea edx,[esp+0x10d8]
mov dword[esp+0x90],eax
mov eax,0x200
lea ecx,[esp+0xd8]
mov dword[esp+0xa0],edx
mov edx,dword[esi]
mov dword[esp+0x78],ecx
mov dword[esp+0x94],eax
mov dword[esp+0xa4],eax
mov dword[esp+0x7c],eax
mov dword[esp+0x9c],eax
mov dword[esp+0x88],eax
mov dword[esp+0xac],eax
mov eax,dword[edx+0xc]
add esp,0x24
mov ecx,esi
mov dword[esp+0x50],0x3c
call eax
mov eax,dword[0x446ce4]
cmp eax,edi
jne 0x418430
call fcn.00419100
mov ecx,dword[0x446b68]
push str.WinHttpCrackUrl
push ecx
call dword[sym.imp.KERNEL32.dll_GetProcAddress]
cmp eax,edi
mov dword[0x446ce4],eax
je 0x41843a
lea edx,[esp+0x50]
push edx
push edi
push edi
push ebx
call eax
mov eax,dword[esp+0x7c]
lea esi,[esp+0x98]
mov dword[esp+0xb0],7
mov dword[esp+0xac],edi
mov word[esp+0x9c],di
call fcn.0040411c
mov dword[esp+0x18c8],edi
mov eax,dword[esp+0x84]
push eax
mov esi,eax
call fcn.0041a322
add esp,4
mov ebx,eax
push esi
lea eax,[esp+0x9c]
call fcn.00405d9c
xor eax,eax
lea ebx,[esp+0x3c]
lea edi,[esp+0x40]
mov dword[esp+0x40],eax
mov dword[esp+0x3c],eax
call fcn.004181e0
mov eax,dword[0x445cac]
mov edx,dword[eax+0xc]
mov ecx,0x445cac
call edx
add eax,0x10
mov dword[esp+0x2c],eax
mov byte[esp+0x18c8],1
mov eax,dword[esp+0x3c]
mov ecx,dword[esp+0x40]
push eax
push ecx
lea edx,[esp+0x34]
push str.Mozilla_5.0__compatible__MSIE_8.0__Windows_NT__d._d__QQPCMgr7.0_
push edx
call fcn.004031c4
mov eax,dword[esp+0x3c]
push eax
call fcn.00419370
mov edi,eax
add esp,0x14
test edi,edi
mov dword[esp+0x4c],edi
je 0x418606
mov eax,dword[0x446d0c]
test eax,eax
jne 0x41851e
call fcn.00419100
mov ecx,dword[0x446b68]
push str.WinHttpSetStatusCallback
push ecx
call dword[sym.imp.KERNEL32.dll_GetProcAddress]
test eax,eax
mov dword[0x446d0c],eax
je 0x41852a
push 0
push 0xffffffffffffffff
push 0x418030
push edi
call eax
mov edx,dword[esp+0x1c]
test edx,edx
je 0x41857a
mov eax,edx
lea esi,[eax+2]
mov cx,word[eax]
add eax,2
test cx,cx
jne 0x418537
sub eax,esi
sar eax,1
je 0x41857a
mov dword[esp+0x90],edx
push 0xc
lea edx,[esp+0x90]
push edx
push 0x26
push edi
mov dword[esp+0x9c],3
mov dword[esp+0xa4],0
call fcn.00419420
add esp,0x10
mov eax,dword[0x446ce8]
test eax,eax
movzx esi,word[esp+0x68]
mov ebx,dword[esp+0x60]
mov dword[esp+0x28],4
jne 0x4185b3
call fcn.00419100
mov eax,dword[0x446b68]
push str.WinHttpConnect
push eax
call dword[sym.imp.KERNEL32.dll_GetProcAddress]
test eax,eax
mov dword[0x446ce8],eax
je 0x4185cd
push 0
push esi
push ebx
push edi
call eax
mov esi,eax
test esi,esi
mov dword[esp+0x20],esi
jne 0x4186e9
mov eax,dword[0x446ce8]
test eax,eax
movzx esi,word[esp+0x68]
mov ebx,dword[esp+0x60]
jne 0x4186d4
call fcn.00419100
mov ecx,dword[0x446b68]
push str.WinHttpConnect
push ecx
call dword[sym.imp.KERNEL32.dll_GetProcAddress]
test eax,eax
mov dword[0x446ce8],eax
jne 0x4186d4
mov dword[esp+0x20],eax
mov esi,dword[esp+0x18]
mov edi,dword[sym.imp.KERNEL32.dll_LeaveCriticalSection]
lea ebx,[esi+0x44]
push ebx
call dword[sym.imp.KERNEL32.dll_EnterCriticalSection]
mov ecx,dword[esp+0x20]
mov edx,dword[esp+0x4c]
push ebx
mov dword[esi+8],ecx
mov dword[esi+4],edx
call edi
mov eax,dword[esp+0x14]
test eax,eax
je 0x418668
mov dword[esp+0x18],eax
mov eax,dword[esp+0x18]
test eax,eax
je 0x418660
mov ecx,dword[esp+0x18]
push ecx
call dword[sym.imp.KERNEL32.dll_InterlockedDecrement]
test eax,eax
jne 0x418660
mov esi,dword[esp+0x18]
call fcn.00417ef0
mov esi,dword[esp+0x18]
call fcn.00417d40
mov dword[esp+0x14],0
mov byte[esp+0x18c8],0
mov eax,dword[esp+0x2c]
add eax,0xfffffff0
lea edx,[eax+0xc]
or ecx,0xffffffff
lock xadd dword[edx],ecx
dec ecx
test ecx,ecx
jg 0x418690
mov ecx,dword[eax]
mov edx,dword[ecx]
push eax
mov eax,dword[edx+4]
call eax
cmp dword[esp+0xb0],8
jb 0x4186aa
mov ecx,dword[esp+0x9c]
push ecx
call fcn.0041a2b0
add esp,4
mov eax,dword[esp+0x24]
mov ecx,dword[esp+0x18c0]
mov dword fs:[0],ecx
pop ecx
pop edi
pop esi
pop ebx
mov ecx,dword[esp+0x18a8]
xor ecx,esp
call fcn.0041a8a0
mov esp,ebp
pop ebp
ret 8
push 0
push esi
push ebx
push edi
call eax
test eax,eax
mov dword[esp+0x20],eax
je 0x418606
mov esi,eax
cmp word[esp+0x68],0x1bb
mov edi,0x100
jne 0x4186fc
mov edi,0x800100
cmp dword[esp+0xb0],8
mov eax,dword[esp+0x9c]
jae 0x418714
lea eax,[esp+0x9c]
push edi
push eax
push esi
call fcn.004191a0
mov ebx,eax
add esp,0xc
test ebx,ebx
jne 0x418752
cmp dword[esp+0xb0],8
mov eax,dword[esp+0x9c]
jae 0x41873d
lea eax,[esp+0x9c]
push edi
push eax
push esi
call fcn.004191a0
mov ebx,eax
add esp,0xc
test ebx,ebx
je 0x418606
mov esi,dword[esp+0x18]
lea eax,[esi+0x44]
push eax
call dword[sym.imp.KERNEL32.dll_EnterCriticalSection]
mov edi,dword[sym.imp.KERNEL32.dll_CreateEventW]
push 0
push 0
push 0
push 0
call edi
push 0
push 0
push 0
push 0
mov dword[esi+0x34],eax
call edi
push 0
push 0
push 0
push 0
mov dword[esi+0x38],eax
call edi
push 0
push 0
push 0
push 0
mov dword[esi+0x3c],eax
call edi
mov edx,dword[esi+0x3c]
mov ecx,dword[esi+0x34]
lea edi,[esi+0x30]
push edi
push eax
push edx
mov dword[esi+0x40],eax
mov eax,dword[esi+0x38]
push eax
push ecx
push ebx
call fcn.00417db0
add esp,0x18
test eax,eax
jne 0x418948
mov edi,dword[edi]
test edi,edi
je 0x418948
mov ebx,dword[sym.imp.KERNEL32.dll_InterlockedIncrement]
mov eax,edi
mov dword[esp+0x1c],eax
mov edx,dword[esp+0x1c]
push edx
mov dword[esp+0x18],eax
call ebx
mov edi,dword[sym.imp.KERNEL32.dll_LeaveCriticalSection]
lea eax,[esi+0x44]
push eax
call edi
mov eax,dword[esp+0x14]
mov dword[esp+0x1c],eax
mov ecx,dword[esp+0x1c]
push ecx
call ebx
mov eax,dword[esp+0x14]
mov ecx,dword[eax+0x20]
push 4
lea edx,[esp+0x18]
push edx
push 0x2d
push ecx
call fcn.00419420
add esp,0x10
test eax,eax
jne 0x41882b
mov edx,dword[esi+0x40]
push edx
call dword[sym.imp.KERNEL32.dll_CloseHandle]
mov dword[esi+0x40],0
jmp 0x418610
mov eax,dword[esp+0x14]
call fcn.00417ec0
neg eax
sbb eax,eax
inc eax
mov dword[esp+0x24],eax
je 0x418610
mov eax,dword[esp+0x14]
mov ecx,dword[eax+0x20]
push ecx
call fcn.004191f0
add esp,4
test eax,eax
jne 0x41887a
mov edx,dword[esp+0x14]
mov eax,dword[edx+0x20]
push eax
call fcn.004191f0
add esp,4
test eax,eax
jne 0x41887a
mov ecx,dword[esp+0x14]
add ecx,4
push ecx
call edi
jmp 0x418610
mov edx,dword[esp+0x14]
add edx,4
push edx
call edi
mov eax,dword[esi+0x34]
mov ecx,dword[esi+0x3c]
push 0xea60
xor ebx,ebx
push ebx
lea edx,[esp+0x4c]
push edx
push 2
mov dword[esp+0x54],eax
mov dword[esp+0x58],ecx
call dword[sym.imp.KERNEL32.dll_WaitForMultipleObjects]
cmp eax,ebx
jne 0x418610
mov eax,dword[esp+0x14]
call fcn.00417ec0
neg eax
sbb eax,eax
inc eax
mov dword[esp+0x24],eax
je 0x418610
mov edx,dword[esp+0x14]
push ebx
lea eax,[esp+0x2c]
push eax
mov eax,dword[edx+0x20]
lea ecx,[esp+0x38]
push ecx
push ebx
push 0x20000013
push eax
call fcn.00419270
add esp,0x18
cmp dword[esp+0x30],0xc8
je 0x418905
mov ecx,dword[esp+0x14]
add ecx,4
push ecx
mov dword[esp+0x28],ebx
call edi
jmp 0x418610
lea edx,[esp+0x38]
push edx
mov edx,dword[esp+0x18]
lea eax,[esp+0x2c]
push eax
lea ecx,[esp+0x3c]
push ecx
push ebx
mov dword[esp+0x48],ebx
mov eax,dword[edx+0x20]
push 0x20000005
push eax
call fcn.00419270
add esp,0x18
test eax,eax
je 0x418939
mov ecx,dword[esp+0x34]
mov dword[esi+0x28],ecx
mov edx,dword[esp+0x14]
add edx,4
push edx
call edi
jmp 0x418610
mov eax,dword[esi+0x40]
push eax
call dword[sym.imp.KERNEL32.dll_CloseHandle]
lea eax,[esi+0x44]
push eax
mov dword[esi+0x40],0
call dword[sym.imp.KERNEL32.dll_LeaveCriticalSection]
jmp 0x41860a
{% endhighlight %}


[similar_1_ref]: /report/fcn.100066c0@4c3818fdf32d89a09257dbc9d3e142ea
[similar_2_ref]: /report/fcn.0044f064@20a93604f17ee6f3c2aa7b1f7a497fcf
[similar_3_ref]: /report/fcn.0041f004@418e0921f3a9bd4f5bc0dcc59623b5a1
[similar_4_ref]: /report/fcn.004371a0@4fe6510221c33bf023f6abed461fc13f
[similar_5_ref]: /report/fcn.004034a9@912f1d013a0d6151bc7a7cef6da1b2a0
[virustotal_ref]: https://www.virustotal.com/gui/file/0aa2d73a5300dff2412388945614b507